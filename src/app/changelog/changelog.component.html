<app-navbar></app-navbar>

<div class="changelog">
  <h2>Change Log</h2>

  <div class="search-content">
    <label for="search">Search </label>
    <input type="text" id="search" [(ngModel)]="searchText" placeholder="Search any column data globally..." />
    <br />
    <br />
    <label for="searchColumn"> Filter Column </label>
    <select
      id="searchColumn"
      [(ngModel)]="searchColumn"
      class="search-column-dropdown"
    >
      <option value="" [class.highlighted]="searchColumn === ''">
        All Columns
      </option>
      <option
        *ngFor="let column of tableColumns"
        [value]="column.field"
        [class.highlighted]="searchColumn === column.field"
      >
        {{ column.header }}
      </option>
    </select>
  </div>

  <div *ngIf="filteredData().length === 0">
    <p class="nodata">No Data Found for Entered Search!</p>
  </div>

  <div *ngIf="isAdmin()" class="admin-control">
    <div class="button-container">
    <button (click)="toggleButtonsVisibility()" class="icon-button">
      <i class="material-icons">{{ isButtonsVisible ? 'remove' : 'add' }}</i>
    </button>
    <div *ngIf="isButtonsVisible" class="stacked-buttons">
       <button (click)="addData()">Add New Row</button>
       <button *ngIf="isAdmin()" (click)="deleteSelectedRows()" [disabled]="!selectedRows.length">
        <i class="fas fa-trash"></i>
      </button>
    </div>
  </div>
    <div class="button-container">
      <div *ngIf="isColumnActionsVisible">
        <button (click)="editColumnData()">Edit Column Data</button>
        <button (click)="deleteColumn()">Delete Column</button> 
        <button (click)="addColumn()">Add New Column</button>
        <input type="text" class="input-column" [(ngModel)]="newColumnName" placeholder="Enter New Column Name" />
      </div>
      <button (click)="toggleColumnActionsVisibility()" class="icon-button">
        <i class="material-icons">{{ isColumnActionsVisible ? 'remove' : 'add' }}</i>
      </button>
    </div>
  </div>


  <div class="table-container-scroll">
  <table *ngIf="filteredData().length > 0">
    <thead>
      <tr>
        <th>
          <input type="checkbox" [(ngModel)]="selectAll" (change)="toggleSelectAll()" />
        </th>
        <!-- <th>Sr. No.</th>
        <th>OFSAA Mapping Change Date</th>
        <th>OFSAA Stage Table Name</th>
        <th>Change Details</th>
        <th>OFSAA Change By</th>
        <th>ODI Build Status</th>
        <th>ODI Build Date</th>
        <th>Verified Y/N</th>
        <th>Verified by</th>
        <th>Verified Date</th>
        <th>Comments</th> -->
        <th *ngFor="let column of tableColumns">{{ column.header }}</th>
        <th *ngIf="isAdmin()">Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let row of filteredData() | paginate: { id: 'changelog-pagination', itemsPerPage: itemsPerPage, currentPage: currentPage }">
        <td>
          <input type="checkbox" [(ngModel)]="row.isSelected" (change)="updateSelectAll()" />
        </td>
        <td *ngFor="let column of tableColumns" [ngSwitch]="column.field">
          
          <!-- Sr. No. -->
          <span *ngSwitchCase="'srNo'">{{ row.srNo }}</span>
    
          <!-- OFSAA Mapping Change Date -->
          <span *ngSwitchCase="'ofsaaMappingChangeDate'">{{ row.ofsaaMappingChangeDate | date: 'shortDate' }}</span>
    
          <!-- OFSAA Stage Table Name (Link) -->
          <span *ngSwitchCase="'ofsaaStageTableName'">
            <span (click)="navigateToDataMappingRule(row.ofsaaStageTableName)" style="cursor: pointer; color: blue;">
              {{ row.ofsaaStageTableName }}
            </span>
          </span>
    
          <!-- Stage (Custom Dropdown) -->
          <div *ngSwitchCase="'stage'">
            <span *ngIf="editingRow !== row">{{ getSelectedStages(row.srNo) }}</span>
            <div *ngIf="editingRow === row">
              <div class="dropdownstyle" (click)="toggleDropdown(row.srNo)">Select Stages</div>
              <div class="dropdown-content" *ngIf="isDropdownOpen(row.srNo)">
                <div *ngFor="let stage of stageOptions">
                  <label>
                    <input type="checkbox" [(ngModel)]="selectedStages[row.srNo][stage]" />
                    {{ stage }}
                  </label>
                </div>
              </div>
            </div>
          </div>
    
          <!-- Change Details (Input) -->
          <div *ngSwitchCase="'changeDetails'">
            <input *ngIf="editingRow === row" type="text" [(ngModel)]="row.changeDetails" />
            <span *ngIf="editingRow !== row">{{ row.changeDetails }}</span>
          </div>
    
          <!-- OFSAA Change By (Dropdown) -->
          <div *ngSwitchCase="'ofsaaChangeBy'">
            <select *ngIf="editingRow === row" [(ngModel)]="row.ofsaaChangeBy">
              <option *ngFor="let user of userOptions" [value]="user">{{ user }}</option>
            </select>
            <span *ngIf="editingRow !== row">{{ row.ofsaaChangeBy }}</span>
          </div>
    
          <!-- ODI Build Status (Dropdown) -->
          <div *ngSwitchCase="'odiBuildStatus'">
            <select *ngIf="editingRow === row" [(ngModel)]="row.odiBuildStatus">
              <option *ngFor="let status of buildStatusOptions" [value]="status">{{ status }}</option>
            </select>
            <span *ngIf="editingRow !== row">{{ row.odiBuildStatus }}</span>
          </div>
    
          <!-- Default Case for Other Columns -->
          <span *ngSwitchDefault>{{ row[column.field] }}</span>
        </td>
        
        <!-- Actions Column (Fixed at the End) -->
        <td *ngIf="isAdmin()">
          <button (click)="toggleEdit(row)">
            {{ editingRow === row ? 'Save' : 'Edit' }}
          </button>
        </td>
      </tr>
    </tbody>
  </table>
  <pagination-controls
    id="table-pagination"
    [id]="'table-pagination'"
    [autoHide]="true"
    [maxSize]="5"
    (pageChange)="currentPage = $event"
    ></pagination-controls>
  </div>
   <div *ngIf="isAdmin()" class="column-button">
    <button (click)="saveChanges()"> Save </button>
    <button (click)="exportToExcel()">Export</button>
    <button (click)="undoDeleteColumn()">Undo Deletion</button> 
  </div>
</div>
